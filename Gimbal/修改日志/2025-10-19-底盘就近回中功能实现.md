# 底盘就近回中功能实现

## 修改日期
2025-10-19

## 版本历史
- **v1.0** (2025-10-19 01:00): 初版实现，使用P+D控制
- **v1.1** (2025-10-19 01:30): 优化版本
  - 使用`math.h`和`arm_math.h`优化数学计算
  - 改用PID控制器替代直接P+D计算
  - 简化代码结构，提高可维护性

## 修改概述
基于原版单板代码的就近回中逻辑，在双板架构下实现了底盘跟随云台的就近回中功能，支持车头翻转优化。使用PID控制器配合就近回中误差计算，既保留了PID调参的灵活性，又实现了路径优化。

## 核心思想
原版代码使用编码器值进行就近路径选择，新版代码保留了核心算法，但改用云台Yaw电机编码器角度作为数据源，通过以下机制实现：

1. **就近路径选择**：当云台与底盘偏差角度超过90度时，允许底盘选择反向180度作为目标，实现更短的回中路径
2. **车头翻转**：通过翻转状态机(flip_state)动态切换目标角度(0度或180度)
3. **PID控制**：使用成熟的PID控制器，配合优化后的误差反馈，保留调参灵活性
4. **平滑过渡**：保留一阶低通滤波器，避免控制量突变
5. **数学优化**：使用`math.h`的`fmodf()`和`arm_math.h`的函数优化计算性能

## 详细修改内容

### 1. 参数定义 (`application/robot_def.h`)

添加了就近回中相关参数：
```c
// 底盘跟随就近回中参数
#define CHASSIS_FOLLOW_ALLOW_FLIP 1          // 是否允许车头翻转(0:不允许, 1:允许)
#define CHASSIS_FOLLOW_FLIP_THRESHOLD 90.0f  // 车头翻转触发阈值(度)
#define CHASSIS_FOLLOW_KP 4.0f               // 跟随比例系数
#define CHASSIS_FOLLOW_KD 1.0f               // 跟随微分系数(用于抑制抖动)
#define CHASSIS_FOLLOW_MAX_ERR 135.0f        // 最大允许误差(度),避免控制量过大
```

在底盘控制命令结构体中添加字段：
```c
typedef struct {
  // ... 原有字段 ...
  float near_center_error;         // 就近回中误差(考虑翻转优化后)
  float near_center_error_diff;    // 误差微分项(用于阻尼控制)
  // ...
} Chassis_Ctrl_Cmd_s;
```

### 2. 误差计算函数 (`application/cmd/robot_cmd.c`)

新增`CalcNearCenterError()`函数，核心逻辑：

```c
static void CalcNearCenterError(float offset_angle) {
  static uint8_t flip_state = 0;         // 翻转状态: 0-正向, 1-反向
  static float error_history[2] = {0};   // 误差历史用于差分计算
  
  // 1. 根据flip_state确定目标角度(0度或180度)
  // 2. 计算误差并归一化到[-180, 180]
  // 3. 当误差超过90度时切换flip_state
  // 4. 误差限幅到±135度
  // 5. 计算一阶差分: error_diff = error_history[0] - error_history[1]
  // 6. 更新误差历史
}
```

**关键机制**：
- **翻转触发**：当 `|error| > 90°` 时，自动切换目标角度(0°↔180°)
- **就近选择**：总是选择绝对值更小的误差路径
- **差分抑制**：通过一阶差分提供阻尼，防止振荡

### 3. 任务流程更新 (`application/cmd/robot_cmd.c`)

在`RobotCMDTask()`中添加调用：
```c
CalcOffsetAngle();                              // 计算原始偏差角
CalcNearCenterError(chassis_cmd_send.offset_angle);  // 计算就近误差和微分项
RemoteControlSet();                             // 遥控器控制
```

### 4. 底盘控制逻辑 (`application/chassis/chassis.c`)

替换原有PID控制为P+D控制：
```c
case CHASSIS_FOLLOW_GIMBAL_YAW: {
  // 控制律: wz = -error * Kp + error_diff * Kd
  float control_output = 
      -chassis_cmd_recv.near_center_error * CHASSIS_FOLLOW_KP 
      + chassis_cmd_recv.near_center_error_diff * CHASSIS_FOLLOW_KD;
  
  // 低通滤波平滑
  chassis_cmd_recv.wz = LowPassFilter_Float(control_output, 0.25f, &last_follow_wz);
  break;
}
```

**控制律说明**：
- **比例项** `-error * Kp`：驱动底盘向目标旋转
- **微分项** `+error_diff * Kd`：提供阻尼，抑制过冲和振荡
- **低通滤波** `K=0.25`：平滑控制量，避免突变

## 参数调优建议

### 关键参数
1. **`CHASSIS_FOLLOW_KP`** (当前: 4.0)
   - 增大：响应更快，但可能振荡
   - 减小：响应平缓，但跟随滞后
   - 建议范围：3.0 ~ 6.0

2. **`CHASSIS_FOLLOW_KD`** (当前: 1.0)
   - 增大：阻尼更强，更稳定
   - 减小：阻尼减弱，响应更快但可能振荡
   - 建议范围：0.5 ~ 2.0

3. **`CHASSIS_FOLLOW_FLIP_THRESHOLD`** (当前: 90.0°)
   - 建议保持90度，这是理论最优值
   - 若想更保守(减少翻转)可提高到100-120度

4. **滤波系数 `filter_K`** (当前: 0.25)
   - 小陀螺切换时用0.2(保持旋转惯性)
   - 静止跟随时用0.3-0.4(响应更快)

### 调试流程
1. **验证翻转逻辑**：
   - 遥控器保持中位，手动旋转云台180度
   - 观察底盘是否选择就近路径回中(而非绕远路)
   
2. **调整响应速度**：
   - 若跟随过慢：提高`CHASSIS_FOLLOW_KP`
   - 若出现振荡：提高`CHASSIS_FOLLOW_KD`或降低`CHASSIS_FOLLOW_KP`

3. **优化平滑度**：
   - 若控制量跳变明显：降低`filter_K`
   - 若响应滞后：提高`filter_K`

## 功能特性

### 优势
1. **就近回中**：自动选择最短旋转路径，节省时间和功率
2. **车头翻转**：支持前后车头互换，扩大云台活动范围
3. **无积分项**：避免积分饱和问题，响应更直接
4. **平滑过渡**：保留低通滤波，模式切换平稳

### 适用场景
- ✅ 遥控器中位：底盘跟随云台
- ✅ 小陀螺切换：保持旋转动量，平稳过渡
- ✅ 大角度调整：自动选择就近路径

### 与原版对比
| 特性 | 原版PID控制 | 就近回中P+D控制 |
|------|------------|----------------|
| 路径选择 | 固定正向回中 | 动态选择就近路径 |
| 车头翻转 | 不支持 | 支持(±180°) |
| 控制律 | PID串级 | P+D直接控制 |
| 积分项 | 有(可能饱和) | 无(避免饱和) |
| 响应特性 | 稳态精度高 | 暂态响应快 |

## 验证方法

### 基本功能测试
1. **正常跟随**：
   ```
   遥控器中位 → 云台小角度摆动 → 底盘应平稳跟随
   ```

2. **就近回中**：
   ```
   云台快速旋转120度 → 底盘应选择就近方向(±120°而非240°)
   ```

3. **车头翻转**：
   ```
   云台旋转超过90度 → 底盘应切换目标(前后车头互换)
   ```

### 性能测试
- **超调量**：观察底盘回中时是否有明显超调
- **稳态误差**：稳定后偏差角应小于5度
- **振荡测试**：快速摆动云台，底盘不应持续振荡

## 注意事项

1. **参数初值**：当前参数是基于原版代码经验值，实际机器人需要根据：
   - 底盘惯量
   - 电机性能
   - 机械摩擦
   进行微调

2. **翻转逻辑**：若不需要车头翻转功能，将`CHASSIS_FOLLOW_ALLOW_FLIP`设为0即可

3. **坐标系**：确保云台Yaw电机编码器方向与底盘旋转方向定义一致

4. **安全性**：已添加误差限幅(`CHASSIS_FOLLOW_MAX_ERR = 135°`)，防止控制量过大

## 参考原版逻辑
原版代码核心公式：
```c
wz = Middle_err * 4 - (Middle_err_D_1 - Middle_err_D_2)
```
对应新版：
```c
wz = -near_center_error * CHASSIS_FOLLOW_KP + near_center_error_diff * CHASSIS_FOLLOW_KD
```
其中`Middle_err`对应`near_center_error`（经过翻转优化），`(Middle_err_D_1 - Middle_err_D_2)`对应`near_center_error_diff`（一阶差分）。

## 后续优化方向
1. 根据底盘运动状态动态调整Kp、Kd
2. 增加速度前馈补偿
3. 考虑陀螺仪角速度反馈，实现更精确的微分控制
4. 添加UI显示翻转状态和误差信息

---
**作者**：AI Assistant  
**日期**：2025-10-19  
**版本**：v1.0
