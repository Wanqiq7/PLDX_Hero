#!/bin/bash

# ==============================================================================
# Git ä»“åº“è‡ªåŠ¨åŒ–æ›´æ–°ã€æäº¤ä¸æ ‡ç­¾ç®¡ç†è„šæœ¬ (å¢å¼ºç‰ˆ)
# ç‰ˆæœ¬ï¼š4.0.0
# åŠŸèƒ½ï¼š
# 1. æ£€æŸ¥å½“å‰ Git çŠ¶æ€ï¼Œå¹¶æ˜¾ç¤ºå½“å‰åˆ†æ”¯
# 2. åˆ—å‡ºæ‰€æœ‰æœ¬åœ°åˆ†æ”¯ï¼Œè®©ç”¨æˆ·é€‰æ‹©è¦æ“ä½œçš„åˆ†æ”¯
# 3. å¦‚æœå·¥ä½œåŒºä¸å¹²å‡€ï¼Œæä¾›æäº¤é€‰é¡¹
# 4. æ‹‰å–è¿œç¨‹ä»“åº“æœ€æ–°ä»£ç ï¼Œä½¿ç”¨ rebase ç­–ç•¥
# 5. æ¨é€æœ¬åœ°æäº¤åˆ°ç”¨æˆ·é€‰æ‹©çš„è¿œç¨‹åˆ†æ”¯
# 6. å¼•å¯¼ç”¨æˆ·åˆ›å»ºå¹¶æ¨é€æ–°çš„ Git æ ‡ç­¾
# ==============================================================================

echo "ğŸš€ å¼€å§‹è‡ªåŠ¨åŒ– Git æµç¨‹..."

# 1. æ£€æŸ¥å½“å‰ç›®å½•æ˜¯å¦ä¸º Git ä»“åº“
if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
    echo "âŒ é”™è¯¯ï¼šå½“å‰ç›®å½•ä¸æ˜¯ä¸€ä¸ª Git ä»“åº“ã€‚è¯·åœ¨ä»“åº“æ ¹ç›®å½•æ‰§è¡Œæ­¤è„šæœ¬ã€‚"
    exit 1
fi

# è·å–å½“å‰åˆ†æ”¯å
current_branch=$(git rev-parse --abbrev-ref HEAD)
echo "â¡ï¸ å½“å‰åˆ†æ”¯ï¼š${current_branch}"

# 2. é€‰æ‹©è¦æ“ä½œçš„åˆ†æ”¯
echo ""
echo "è¯·é€‰æ‹©è¦æ“ä½œçš„åˆ†æ”¯ï¼š"
branches=($(git branch --format="%(refname:short)"))
for i in "${!branches[@]}"; do
    echo "  $((i+1))) ${branches[$i]}"
done
read -p "è¯·è¾“å…¥åˆ†æ”¯å¯¹åº”çš„æ•°å­—ï¼ˆé»˜è®¤ä¸º ${current_branch}ï¼‰ï¼š " branch_choice

if [[ -z "$branch_choice" ]]; then
    target_branch=$current_branch
elif [[ "$branch_choice" -le ${#branches[@]} && "$branch_choice" -gt 0 ]]; then
    target_branch=${branches[$((branch_choice-1))]}
else
    echo "âŒ é”™è¯¯ï¼šæ— æ•ˆçš„é€‰é¡¹ã€‚æ“ä½œå–æ¶ˆã€‚"
    exit 1
fi

echo "âœ… ä½ é€‰æ‹©çš„åˆ†æ”¯æ˜¯ï¼š${target_branch}"
echo ""

# 3. å°è¯•åˆ‡æ¢åˆ°ç›®æ ‡åˆ†æ”¯
if [[ "$target_branch" != "$current_branch" ]]; then
    echo "â¡ï¸ æ­£åœ¨å°è¯•åˆ‡æ¢åˆ°åˆ†æ”¯ï¼š${target_branch}..."
    if ! git checkout "$target_branch" > /dev/null 2>&1; then
        echo "âŒ é”™è¯¯ï¼šåˆ‡æ¢åˆ†æ”¯å¤±è´¥ã€‚å½“å‰å·¥ä½œåŒºä¸å¹²å‡€ã€‚"
        read -p "æ˜¯å¦è¦æäº¤å½“å‰åˆ†æ”¯'${current_branch}'çš„ä¿®æ”¹ï¼Ÿ (y/n): " confirm_commit
        if [[ "$confirm_commit" == "y" ]]; then
            echo "â¡ï¸ æ­£åœ¨æš‚å­˜æ‰€æœ‰æ–‡ä»¶å˜æ›´..."
            git add .
            read -p "è¯·è¾“å…¥æäº¤ä¿¡æ¯ï¼š " commit_message
            if [[ -z "$commit_message" ]]; then
                echo "âŒ é”™è¯¯ï¼šæäº¤ä¿¡æ¯ä¸èƒ½ä¸ºç©ºã€‚æ“ä½œå–æ¶ˆã€‚"
                exit 1
            fi
            if ! git commit -m "$commit_message"; then
                echo "âŒ é”™è¯¯ï¼šæäº¤å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥ã€‚"
                exit 1
            fi
            echo "âœ… æäº¤æˆåŠŸï¼Œå†æ¬¡å°è¯•åˆ‡æ¢åˆ†æ”¯..."
            if ! git checkout "$target_branch" > /dev/null 2>&1; then
                echo "âŒ é”™è¯¯ï¼šå†æ¬¡åˆ‡æ¢åˆ†æ”¯å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è§£å†³é—®é¢˜ã€‚"
                exit 1
            fi
            echo "âœ… å·²æˆåŠŸåˆ‡æ¢åˆ°åˆ†æ”¯ï¼š${target_branch}ã€‚"
        else
            echo "âœ… ç”¨æˆ·é€‰æ‹©ä¸æäº¤ã€‚è¯·æ‰‹åŠ¨è§£å†³å·¥ä½œåŒºé—®é¢˜åå†æ¬¡è¿è¡Œè„šæœ¬ã€‚"
            exit 0
        fi
    else
        echo "âœ… å·²æˆåŠŸåˆ‡æ¢åˆ°åˆ†æ”¯ï¼š${target_branch}ã€‚"
    fi
fi

# 4. æ‹‰å–æœ€æ–°ä»£ç 
echo "â¡ï¸ æ­£åœ¨æ‹‰å–è¿œç¨‹ä»“åº“æœ€æ–°ä»£ç ..."
if ! git pull --rebase; then
    echo "âŒ é”™è¯¯ï¼šæ‹‰å–æœ€æ–°ä»£ç å¤±è´¥ã€‚å¯èƒ½å­˜åœ¨åˆå¹¶å†²çªï¼Œè¯·æ‰‹åŠ¨è§£å†³åé‡è¯•ã€‚"
    exit 1
fi
echo "âœ… ä»£ç å·²æˆåŠŸåŒæ­¥åˆ°æœ€æ–°ã€‚"

# 5. æ£€æŸ¥å¹¶æäº¤ä¿®æ”¹
echo "â¡ï¸ æ­£åœ¨æš‚å­˜æ‰€æœ‰æ–‡ä»¶å˜æ›´..."
git add .
if git diff --cached --quiet; then
    echo "âœ… æ²¡æœ‰æ–°çš„ä¿®æ”¹éœ€è¦æäº¤ï¼Œè·³è¿‡æäº¤æ­¥éª¤ã€‚"
else
    read -p "è¯·è¾“å…¥æäº¤ä¿¡æ¯ï¼ˆä¾‹å¦‚: 'feat: add new feature'ï¼‰ï¼š " commit_message
    if [[ -z "$commit_message" ]]; then
        echo "âŒ é”™è¯¯ï¼šæäº¤ä¿¡æ¯ä¸èƒ½ä¸ºç©ºã€‚æ“ä½œå–æ¶ˆã€‚"
        exit 1
    fi
    if ! git commit -m "$commit_message"; then
        echo "âŒ é”™è¯¯ï¼šæäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶çŠ¶æ€ã€‚"
        exit 1
    fi
    echo "âœ… æäº¤æˆåŠŸã€‚"

    # 6. æ¨é€æäº¤
    echo "â¡ï¸ æ¨é€æäº¤åˆ°è¿œç¨‹ä»“åº“..."
    if ! git push origin "${target_branch}"; then
        echo "âŒ é”™è¯¯ï¼šæ¨é€å¤±è´¥ã€‚å¯èƒ½å­˜åœ¨ç½‘ç»œé—®é¢˜æˆ–è¿œç¨‹ä»“åº“å·²æ›´æ–°ï¼Œè¯·å†æ¬¡è¿è¡Œè„šæœ¬ã€‚"
        exit 1
    fi
    echo "âœ… ä»£ç å·²æˆåŠŸæ¨é€åˆ°è¿œç¨‹åˆ†æ”¯'${target_branch}'ã€‚"
fi

---

### **æ ‡ç­¾ç®¡ç†éƒ¨åˆ†**

echo ""
echo "----------------------------------------"
echo "ğŸ·ï¸ å¼€å§‹å¤„ç† Git æ ‡ç­¾..."
read -p "è¯·è¾“å…¥æ–°çš„ç‰ˆæœ¬æ ‡ç­¾ï¼ˆä¾‹å¦‚: 'v1.0.0' æˆ– 'v1.1.0'ï¼‰ï¼Œæˆ–ç›´æ¥å›è½¦è·³è¿‡ï¼š " tag_name

if [[ -z "$tag_name" ]]; then
    echo "âœ… è·³è¿‡æ ‡ç­¾åˆ›å»ºï¼Œè„šæœ¬æ‰§è¡Œå®Œæ¯•ã€‚"
    exit 0
fi

if git rev-parse --verify "refs/tags/${tag_name}" >/dev/null 2>&1; then
    echo "âš ï¸ è­¦å‘Šï¼šæ ‡ç­¾ '$tag_name' å·²å­˜åœ¨ã€‚è¯·ä½¿ç”¨ä¸€ä¸ªæ–°æ ‡ç­¾åã€‚"
else
    git tag -a "$tag_name" -m "Release $tag_name"
    echo "âœ… æœ¬åœ°æ ‡ç­¾ '$tag_name' å·²åˆ›å»ºã€‚"
    git push origin "$tag_name"
    echo "âœ… æ ‡ç­¾ '$tag_name' å·²æ¨é€åˆ°è¿œç¨‹ä»“åº“ã€‚"
fi

echo ""
echo "ğŸ‰ è„šæœ¬æ‰§è¡Œå®Œæ¯•ã€‚ä»“åº“å·²æ›´æ–°å¹¶ä¸Šä¼ æ ‡ç­¾ã€‚"