# 项目上下文摘要（超级电容通信配置检查）

生成时间：2025-01-16

## 1. 相似实现分析

### 实现1: RM2024-SuperCapacitorController-master/Core/Src/Communication.cpp:1-113
- **模式**：基于 HAL 库的 CAN 通信，使用结构体打包数据
- **可复用**：
  - `RxData` 和 `TxData` 结构体定义（使用 `__attribute__((packed))`）
  - CAN 过滤器配置方式
  - 直接操作寄存器的高性能发送方法
- **需注意**：
  - 使用静态断言确保结构体大小为 8 字节
  - CAN ID 硬编码：发送 0x051，接收 0x061
  - 数据包含 float 类型，需要注意字节序

### 实现2: Chassis/modules/super_cap/super_cap.c:1-44
- **模式**：模块化设计，使用回调函数处理接收数据
- **可复用**：
  - `CANInstance` 封装的 CAN 通信抽象层
  - `SuperCapRxCallback` 回调函数机制
  - 单例模式管理超级电容实例
- **需注意**：
  - 手动字节拼接（大端序）：`rxbuff[0] << 8 | rxbuff[1]`
  - 当前数据结构与超级电容控制器不匹配
  - 使用 `malloc` 动态分配内存

### 实现3: Chassis/application/chassis/chassis.c:200-206
- **模式**：应用层初始化配置
- **可复用**：
  - `SuperCap_Init_Config_s` 配置结构
  - CAN2 总线配置
- **需注意**：
  - 当前 CAN ID 配置错误：tx_id=0x302, rx_id=0x301
  - 与超级电容控制器的 ID 完全不匹配

## 2. 项目约定

- **命名约定**：
  - 结构体类型：`XXX_s` 或 `XXX_t` 后缀
  - 初始化函数：`XXXInit()`
  - 回调函数：`XXXCallback()`
  - 实例指针：`xxx_instance`
- **文件组织**：
  - `modules/` - 可复用设备模块
  - `application/` - 应用层业务逻辑
  - `bsp/` - 板级支持包
- **导入顺序**：标准库 -> BSP -> 模块 -> 应用
- **代码风格**：
  - 使用简体中文注释
  - 缩进：4 空格或 2 空格（取决于文件）
  - 大括号：换行风格

## 3. 可复用组件清单

- `bsp/bsp_can.c/h` - CAN 总线抽象层，提供 `CANRegister()` 和 `CANTransmit()` 接口
- `modules/can_comm/` - CAN 通信模块，用于双板通信
- `Chassis/modules/super_cap/` - 超级电容模块（需修改）

## 4. 测试策略

- **测试框架**：无自动化测试，依赖硬件验证
- **测试模式**：集成测试，CAN 总线实际通信验证
- **验证方式**：
  - 使用 CAN 分析仪监控总线数据
  - 通过 SEGGER RTT 日志输出调试信息
  - 检查超级电容反馈数据的正确性
- **覆盖要求**：
  - 正常通信流程：发送控制指令，接收反馈数据
  - 边界条件：功率限制、能量缓冲区范围
  - 错误处理：CAN 总线错误、数据校验失败

## 5. 依赖和集成点

- **外部依赖**：STM32 HAL 库（CAN、UART、Flash）
- **内部依赖**：
  - `bsp_can` - CAN 总线驱动
  - `referee` 模块 - 裁判系统数据（功率限制、能量缓冲区）
  - `power_controller` 模块 - 功率控制算法
- **集成方式**：
  - CAN 中断回调：`CANInstance` 回调机制
  - 数据获取：`SuperCapGet()` 函数
  - 控制指令：`SuperCapSend()` 函数
- **配置来源**：
  - `robot_def.h` - 机器人参数定义
  - 应用层初始化代码中的配置结构体

## 6. 技术选型理由

- **为什么用 CAN 总线**：
  - RoboMaster 标准通信协议
  - 高可靠性、实时性强
  - 支持多节点通信
- **优势**：
  - 硬件支持完善
  - 抗干扰能力强
  - 协议简单高效
- **劣势和风险**：
  - CAN ID 冲突风险
  - 数据格式不统一需要手动对齐
  - 调试相对困难（需要 CAN 分析仪）

## 7. 关键风险点

### 并发问题
- CAN 中断回调与主任务可能并发访问超级电容数据
- 需要考虑数据保护（当前实现未加锁，但单次读取操作原子性足够）

### 边界条件
- 功率限制范围：30-250W
- 能量缓冲区：0-300J
- 电容能量：0-255（归一化）
- CAN ID 范围：标准帧 0x000-0x7FF

### 性能瓶颈
- CAN 总线负载：1Mbps 速率，需要控制发送频率
- 超级电容反馈频率未知，可能影响控制实时性

### 关键问题（当前发现）
- **CAN ID 完全不匹配**：
  - 超级电容发送 0x051，底盘期望 0x301 ❌
  - 底盘发送 0x302，超级电容期望 0x061 ❌
- **数据格式不兼容**：
  - 超级电容：{errorCode, chassisPower(float), chassisPowerLimit, capEnergy}
  - 底盘期望：{vol(uint16), current(uint16), power(uint16)} ❌
- **字节序和类型错误**：
  - float 4字节被当作 uint16 解析会导致数据错乱
  - 底盘使用大端序手动拼接，但 float 是自然字节序
