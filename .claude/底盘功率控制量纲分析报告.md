# 底盘功率控制量纲分析报告

生成时间：2025-11-18

## 一、问题概述

在底盘功率控制中，电机转矩的计算有两种方法：
1. **转子侧计算**：使用转子转速 + 转子转矩常数
2. **输出轴侧计算**：使用输出轴转速 + 输出轴转矩常数

本报告分析当前代码使用的方法，并检查量纲是否正确。

---

## 二、M3508电机参数分析

### 2.1 官方参数（来自参数手册）

| 参数 | 数值 | 单位 | 说明 |
|------|------|------|------|
| 额定转矩 | 3.0 | N·m | **输出轴**转矩 |
| 额定电流 | 10 | A | 额定工作电流 |
| 转矩常数（输出轴） | 0.3 | N·m/A | 3.0 / 10 = 0.3 |
| 减速比 | 3591:187 ≈ 19.2 | - | 实际使用19.0 |

### 2.2 转子侧参数推导

根据 GMaster 开源报告（PDF第4页，公式3）：

```
Kt_rotor = Kt_output / 减速比
         = 0.3 × (187/3591)
         = 0.3 / 19.2
         = 0.01562 N·m/A
```

**关键理解**：
- M3508参数手册给出的 0.3 N·m/A 是**输出轴的转矩常数**
- 电机CAN反馈的 `speed_aps` 是**转子的角速度**（度/秒）
- 要在转子侧计算功率，需要使用转子转矩常数

---

## 三、功率计算的两种正确方法

### 方法1：转子侧计算（推荐）

```c
// 转子角速度 (rad/s)
ω_rotor = speed_aps × (π/180)

// 转子转矩 (N·m)
τ_rotor = I × Kt_rotor = I × (0.3 / 19.0) = I × 0.01579

// 机械功率 (W)
P = τ_rotor × ω_rotor
```

**优势**：直接使用电机反馈的转子转速，无需换算。

### 方法2：输出轴侧计算

```c
// 输出轴角速度 (rad/s)
ω_output = speed_aps × (π/180) / 减速比 = ω_rotor / 19.0

// 输出轴转矩 (N·m)
τ_output = I × Kt_output = I × 0.3

// 机械功率 (W)
P = τ_output × ω_output
```

**验证等价性**：
```
P = (I × 0.3) × (ω_rotor / 19.0)
  = I × (0.3 / 19.0) × ω_rotor
  = I × 0.01579 × ω_rotor  ✓ 与方法1相同
```

---

## 四、当前代码分析

### 4.1 力到电流转换（chassis.c:552）✅ 正确

```c
static const float force_to_current = RADIUS_WHEEL / M3508_TORQUE_CONSTANT;
// 公式：电流 = 力 × 半径 / 转矩常数
```

**分析**：
- 力 F 作用在轮子上（输出轴）
- 转矩：τ_output = F × RADIUS_WHEEL
- 电流：I = τ_output / Kt_output = (F × r) / 0.3

**结论**：使用输出轴转矩常数 0.3 N·m/A 是**正确的**。

### 4.2 功率反馈计算（chassis.c:708-728）❌ 错误！

```c
// 转子角速度（正确）
float motor_speeds[4] = {
    motor_lf->measure.speed_aps * DEGREE_2_RAD,  // rad/s（转子）
    motor_rf->measure.speed_aps * DEGREE_2_RAD,
    motor_lb->measure.speed_aps * DEGREE_2_RAD,
    motor_rb->measure.speed_aps * DEGREE_2_RAD,
};

// 输出轴转矩（错误！应该是转子转矩）
const float TORQUE_CONSTANT = 0.3f; // Nm/A（输出轴）
float motor_torques[4] = {
    motor_lf->measure.real_current * M3508_CMD_TO_CURRENT_COEFF * TORQUE_CONSTANT,
    motor_rf->measure.real_current * M3508_CMD_TO_CURRENT_COEFF * TORQUE_CONSTANT,
    motor_lb->measure.real_current * M3508_CMD_TO_CURRENT_COEFF * TORQUE_CONSTANT,
    motor_rb->measure.real_current * M3508_CMD_TO_CURRENT_COEFF * TORQUE_CONSTANT,
};

PowerUpdateMotorFeedback(motor_speeds, motor_torques);
```

**问题诊断**：
- 使用了**转子角速度** ω_rotor（rad/s）
- 使用了**输出轴转矩常数** Kt_output = 0.3 N·m/A
- 这是**错误的混用**！

**量纲错误后果**：
```
错误计算：P = (I × 0.3) × ω_rotor
正确应为：P = (I × 0.01579) × ω_rotor

误差倍数 = 0.3 / 0.01579 ≈ 19.0 倍（减速比）
```

**实际影响**：功率被**高估约19倍**！这会导致：
1. RLS参数辨识严重错误
2. 功率控制器计算错误
3. 底盘可能超功率或性能受限

---

## 五、修正方案

### ⭐ 方案1（推荐）：统一到转子侧计算

```c
// chassis.c:715-729 修改为：

// 使用电机实测电流反馈计算转矩（而非控制指令）
// 这对RLS参数辨识至关重要：必须使用真实消耗的电流，而非期望指令
// real_current范围：-16384~16384，需乘以M3508_CMD_TO_CURRENT_COEFF转换为安培

// ⚠️ 关键修正：使用转子转矩常数（而非输出轴转矩常数）
const float TORQUE_CONSTANT_ROTOR = M3508_TORQUE_CONSTANT / REDUCTION_RATIO_WHEEL;
// = 0.3 / 19.0 = 0.01579 N·m/A（转子侧）

float motor_torques[4] = {
    motor_lf->measure.real_current * M3508_CMD_TO_CURRENT_COEFF * TORQUE_CONSTANT_ROTOR,
    motor_rf->measure.real_current * M3508_CMD_TO_CURRENT_COEFF * TORQUE_CONSTANT_ROTOR,
    motor_lb->measure.real_current * M3508_CMD_TO_CURRENT_COEFF * TORQUE_CONSTANT_ROTOR,
    motor_rb->measure.real_current * M3508_CMD_TO_CURRENT_COEFF * TORQUE_CONSTANT_ROTOR,
};
PowerUpdateMotorFeedback(motor_speeds, motor_torques);
```

**优势**：
- ✅ 直接使用电机反馈的转子转速，无需换算
- ✅ 量纲统一到转子侧
- ✅ 代码改动最小

### 方案2：统一到输出轴侧计算

```c
// chassis.c:708-729 修改为：

// 输出轴角速度（需要除以减速比）
float motor_speeds[4] = {
    motor_lf->measure.speed_aps * DEGREE_2_RAD / REDUCTION_RATIO_WHEEL,
    motor_rf->measure.speed_aps * DEGREE_2_RAD / REDUCTION_RATIO_WHEEL,
    motor_lb->measure.speed_aps * DEGREE_2_RAD / REDUCTION_RATIO_WHEEL,
    motor_rb->measure.speed_aps * DEGREE_2_RAD / REDUCTION_RATIO_WHEEL,
};

// 输出轴转矩（保持不变）
const float TORQUE_CONSTANT = 0.3f; // Nm/A（输出轴）
float motor_torques[4] = {
    motor_lf->measure.real_current * M3508_CMD_TO_CURRENT_COEFF * TORQUE_CONSTANT,
    motor_rf->measure.real_current * M3508_CMD_TO_CURRENT_COEFF * TORQUE_CONSTANT,
    motor_lb->measure.real_current * M3508_CMD_TO_CURRENT_COEFF * TORQUE_CONSTANT,
    motor_rb->measure.real_current * M3508_CMD_TO_CURRENT_COEFF * TORQUE_CONSTANT,
};
PowerUpdateMotorFeedback(motor_speeds, motor_torques);
```

**劣势**：需要额外除以减速比，增加计算开销。

---

## 六、robot_def.h 注释修正建议

当前 robot_def.h:99 的注释：
```c
*       - 力控公式：I = F × r / Kt（不需要再除减速比）
```

**问题**：这个注释容易产生误解，没有说明清楚使用场景。

**建议修改为**：
```c
/**
 * @brief M3508电机转矩常数 (N·m/A)
 * @note 根据官方参数表：
 *       - 转矩常数：0.3 N·m/A（输出轴，参数表直接标注）
 *       - 额定转矩：3 N·m @ 10A → 3/10 = 0.3 ✓ 验证一致
 *       - 这是输出轴的转矩常数（M3508 P19 一体化设计）
 *
 * @warning 使用场景说明：
 *       - 力控公式（输出轴侧）：I = F × r / Kt_output
 *         因为力F作用在轮子上（输出轴），直接用输出轴转矩常数
 *       - 功率计算（转子侧）：P = (I × Kt_rotor) × ω_rotor
 *         因为ω是转子角速度，需使用转子转矩常数 Kt_rotor = Kt_output / 减速比
 */
#define M3508_TORQUE_CONSTANT 0.3f

/**
 * @brief M3508电机转子转矩常数 (N·m/A)
 * @note 用于功率计算时，与转子角速度匹配
 *       Kt_rotor = Kt_output / 减速比 = 0.3 / 19.0
 */
#define M3508_TORQUE_CONSTANT_ROTOR (M3508_TORQUE_CONSTANT / REDUCTION_RATIO_WHEEL)
```

---

## 七、总结

### 当前代码问题

| 代码位置 | 使用方法 | 是否正确 | 说明 |
|---------|---------|---------|------|
| chassis.c:552 | 输出轴侧计算 | ✅ 正确 | 力→电流转换，使用输出轴Kt |
| chassis.c:718-728 | **混用** | ❌ 错误 | 转子ω + 输出轴Kt，功率高估19倍 |

### 推荐修正方案

**立即修正 chassis.c:715-729**，使用**方案1（转子侧计算）**：

```c
const float TORQUE_CONSTANT_ROTOR = M3508_TORQUE_CONSTANT / REDUCTION_RATIO_WHEEL;
float motor_torques[4] = {
    motor_lf->measure.real_current * M3508_CMD_TO_CURRENT_COEFF * TORQUE_CONSTANT_ROTOR,
    motor_rf->measure.real_current * M3508_CMD_TO_CURRENT_COEFF * TORQUE_CONSTANT_ROTOR,
    motor_lb->measure.real_current * M3508_CMD_TO_CURRENT_COEFF * TORQUE_CONSTANT_ROTOR,
    motor_rb->measure.real_current * M3508_CMD_TO_CURRENT_COEFF * TORQUE_CONSTANT_ROTOR,
};
```

### 影响评估

**修正前**：功率计算高估19倍 → RLS辨识错误 → 功率控制失效
**修正后**：功率计算正确 → RLS辨识准确 → 功率控制正常

---

## 八、参考资料

1. **GMaster开源报告**（PDF第4页）：明确说明了转矩常数的转换方法
2. **M3508参数手册**：官方转矩常数 0.3 N·m/A（输出轴）
3. **当前代码库**：
   - `robot_def.h:101` - M3508_TORQUE_CONSTANT定义
   - `chassis.c:552` - 力到电流转换（正确示例）
   - `chassis.c:718-728` - 功率反馈计算（需要修正）

---

**分析完成日期**：2025-11-18
**报告生成工具**：Claude Code
