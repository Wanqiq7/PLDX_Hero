# 底盘轮速系统辨识任务使用说明

## 📋 概述

底盘系统辨识任务用于标定**单轮电机的等效惯量和阻尼系数**，为LQR力控提供精确的物理参数。

## 🎯 目的

通过系统辨识获得：
1. **单轮等效惯量 J_eff** - 用于理解系统动态特性
2. **单轮等效阻尼 b_eff** - 用于计算LQR增益
3. **整车阻尼系数** - b_linear (平移), b_angular (旋转)
4. **LQR最优增益 K** - 直接用于底盘力控代码

## 🔧 使用步骤

### 步骤1：准备测试环境

**硬件准备**：
- ✅ 底盘放置在平坦地面上
- ✅ 确保其他三个轮子不会干扰（可抬起或断电）
- ✅ 确保测试轮子能自由转动
- ✅ 连接Ozone调试器

**软件准备**：
- ✅ 编译并烧录底盘代码（已包含系统辨识任务）
- ✅ 打开Ozone
- ✅ 配置Ozone记录以下变量（1kHz采样）：
  ```
  sysid_data.time_elapsed
  sysid_data.step_input
  sysid_data.motor_output
  ```

### 步骤2：选择辨识目标电机

在 `sysid_task.c` 中修改：
```c
#define CHASSIS_SYS_ID_TARGET_MOTOR 0  // 0-左前(lf), 1-右前(rf), 2-左后(lb), 3-右后(rb)
```

**建议**：先辨识一个电机（如左前），其他电机可使用相同参数。

### 步骤3：启动系统辨识

**方法A：通过消息中心**（推荐）
```c
// 在cmd任务或其他地方发布辨识指令
Chassis_SysID_Ctrl_Cmd_s sysid_cmd = {
    .enable = 1,        // 启动辨识
    .target_motor = 0,  // 左前轮
};
// 发布到 "chassis_sysid_cmd" 话题
```

**方法B：手动触发**
```c
// 在robot.c或chassis.c中添加触发条件
if (遥控器某个开关状态) {
    Chassis_SysID_Ctrl_Cmd_s sysid_cmd = {.enable = 1, .target_motor = 0};
    PubPushMessage(sysid_cmd_pub, &sysid_cmd);
}
```

### 步骤4：Ozone记录数据

**操作流程**：
1. 启动Ozone实时记录
2. 触发系统辨识（enable=1）
3. 等待20秒（默认测试时长）
4. 停止记录
5. 导出CSV文件

**预期现象**：
- 目标电机按2秒间隔正反转动（方波电流）
- 轮速跟随电流变化
- 其他电机保持停止

### 步骤5：MATLAB数据分析

```bash
# 打开MATLAB
cd Chassis
Chassis_Wheel_SysID

# 按提示操作：
# 1. 选择刚导出的CSV文件
# 2. 在图中选择有效数据区间（建议选择中间几个阶跃）
# 3. 等待计算完成
```

**脚本输出**：
- 系统辨识结果（J_eff, b_eff, 拟合度）
- 整车阻尼估算（b_linear, b_angular）
- LQR增益（K_velocity）
- 嵌入式配置代码（可直接复制）

### 步骤6：配置参数到代码

复制MATLAB输出的配置代码到 `chassis.c` 的 `ChassisInit()` 函数中，替换现有的LQR初始化部分。

### 步骤7：验证测试

```bash
# 编译烧录
make clean && make -j8

# 测试底盘运动
# 观察响应速度、稳定性、低速平滑性
```

## 📊 系统模型

### 单轮动力学

```
电机扭矩方程：
  τ_motor = Kt * I                    (电机转矩)
  τ_wheel = τ_motor * ratio           (轮侧转矩)
  J_eff * dω/dt + b_eff * ω = τ_wheel (转动方程)

传递函数：
  ω(s)/I(s) = (Kt * ratio) / (J_eff * s + b_eff)
            = K / (s + a)

其中：
  K = (Kt * ratio) / J_eff  [稳态增益]
  a = b_eff / J_eff         [极点]
```

### 整车阻尼推算

**平移阻尼**：
```
单轮阻力: F_wheel = b_eff/r² * v
四轮总阻力: F_total = 4 * b_eff/r² * v
平移阻尼: b_linear = 4 * b_eff / r²  [N·s/m]
```

**旋转阻尼**：
```
底盘旋转时，轮子切向速度: v = ω_chassis * r_rotation
轮子角速度: ω_wheel = v / r_wheel
单轮阻尼扭矩贡献: τ = b_eff * ω_wheel * r_rotation
四轮总扭矩: τ_total = 4 * b_eff * r_rotation² / r_wheel
旋转阻尼: b_angular = 4 * b_eff * r_rotation² / r_wheel  [N·m·s/rad]
```

## ⚙️ 参数配置

### sysid_task.c 中的测试参数

```c
// 方波阶跃幅值（建议值：3000-8000）
#define CHASSIS_SYS_ID_STEP_AMPLITUDE 5000.0f  // CAN指令值

// 每个阶跃持续时间（建议值：1.5-3秒）
#define CHASSIS_SYS_ID_STEP_INTERVAL 2.0f  // 秒

// 总测试时长（建议值：15-30秒）
#define CHASSIS_SYS_ID_TOTAL_DURATION 20.0f  // 秒

// 目标电机选择
#define CHASSIS_SYS_ID_TARGET_MOTOR 0  // 0-lf, 1-rf, 2-lb, 3-rb
```

**参数调整建议**：
- 幅值太小 → 信噪比低，拟合度差 → 增大到6000-8000
- 幅值太大 → 轮子打滑或过热 → 减小到3000-4000
- 间隔太短 → 系统未稳定 → 增大到3秒
- 间隔太长 → 测试时间长 → 减小到1.5秒

## 📈 数据质量要求

### 好的辨识数据特征

✅ **电流阶跃清晰**
- 方波边沿陡峭
- 幅值稳定（无漂移）

✅ **速度响应平滑**
- 阶跃后单调上升
- 稳态时无大幅波动
- 无明显噪声

✅ **拟合度高**
- 拟合度 > 85% ：优秀 ⭐⭐⭐
- 拟合度 70-85%：良好 ⭐⭐
- 拟合度 < 70% ：需重新采集 ❌

### 常见数据问题

❌ **问题1：拟合度很低（<60%）**
- 原因：其他轮子未停止，相互干扰
- 解决：确保只有目标电机运行

❌ **问题2：速度波动大**
- 原因：地面不平整或轮子卡顿
- 解决：换平坦地面，检查轮子

❌ **问题3：电流和速度不对应**
- 原因：记录的不是同一个电机数据
- 解决：检查Ozone变量配置

## 🔍 结果解读

### 典型辨识结果

```
单轮等效惯量 J_eff = 0.001234 kg·m²
单轮等效阻尼 b_eff = 0.015678 N·m·s/rad
拟合度 = 92.3%

整车阻尼:
  b_linear = 16.85 N·s/m
  b_angular = 2.34 N·m·s/rad

LQR增益:
  平移: K_velocity = 143.2 N/(m/s)
  旋转: K_velocity = 48.7 N·m/(rad/s)
```

### 合理性检查

**J_eff 检查**：
```
单轮等效惯量应在: 0.0008 ~ 0.0020 kg·m²
如果超出范围，可能是：
  - 太小: 减速比错误，或轮子空转
  - 太大: 包含了底盘质量（应该只是轮子）
```

**b_linear 检查**：
```
整车平移阻尼应在: 10 ~ 25 N·s/m
参考值:
  - 光滑地板: 10-15
  - 普通地面: 15-20
  - 地毯/粗糙: 20-30
```

**K_velocity 检查**：
```
平移LQR增益应在: 80 ~ 250 N/(m/s)
旋转LQR增益应在: 30 ~ 100 N·m/(rad/s)

如果超出很多，检查：
  - 电机参数（Kt, GearRatio, r_wheel）是否正确
  - 底盘质量M是否正确
```

## ⚠️ 注意事项

### 安全提醒

1. **测试前检查**
   - 底盘稳定放置，不会翻倒
   - 测试轮子能自由转动
   - 周围无障碍物

2. **测试中监控**
   - 电机温度（不应快速升高）
   - 电流范围（应在±10A内）
   - 准备急停

3. **测试后**
   - 检查拟合度（应>70%）
   - 参数合理性检查
   - 保存原始数据备份

### 故障排查

| 现象 | 可能原因 | 解决方案 |
|------|----------|----------|
| 电机不转 | 电机未使能 | 检查sysid_task.c配置 |
| 其他轮也在转 | 目标电机选择错误 | 检查CHASSIS_SYS_ID_TARGET_MOTOR |
| 拟合度<50% | 数据质量差 | 重新采集，选择稳态段 |
| K值异常大/小 | 单位转换错误 | 检查CSV列是否正确 |
| MATLAB报错 | 列名不匹配 | 手动修改脚本第65-90行 |

## 📝 快速检查清单

**测试前**：
- [ ] 已在sysid_task.c设置目标电机
- [ ] 已配置Ozone记录变量
- [ ] 底盘放置稳定
- [ ] 准备好急停

**测试中**：
- [ ] Ozone正在记录
- [ ] 目标电机在转动
- [ ] 其他电机已停止
- [ ] 电机温度正常

**测试后**：
- [ ] 已导出CSV文件
- [ ] 已运行MATLAB脚本
- [ ] 拟合度>70%
- [ ] 参数合理性检查通过
- [ ] 已复制代码到chassis.c

## 🎓 相关文档

- `../../Chassis_Wheel_SysID.m` - MATLAB辨识脚本
- `../../底盘LQR力控使用指南.md` - LQR使用教程
- `../../LQR力控策略实现总结.md` - 技术架构

---

**更新日期**: 2025-01-04  
**适用于**: Chassis v2.0 (LQR力控)
